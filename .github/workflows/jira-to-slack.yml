name: Jira to Slack Integration

on:
  # Schedule: Run every day at 9 AM UTC
  # Adjust the time as needed (uses UTC timezone)
  schedule:
    - cron: '0 9 * * *'  # 9 AM UTC daily

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

  # Optional: Run on push to main (for testing)
  # push:
  #   branches: [ main ]

jobs:
  send-jira-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Load .env file (if using python-dotenv)
        run: |
          pip install python-dotenv

      - name: Run Jira to Slack integration
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          # If using Bot Token instead:
          # SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          # SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
        run: |
          python jira_to_slack.py

      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: error-logs
          path: '*.log'
          retention-days: 7
